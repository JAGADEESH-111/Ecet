<!DOCTYPE html>
<html>
<head>
  <title>Daily Quiz</title>
  <style>
  body{
    background-color: silver;
  }
    button {
      margin: 5px 0;
      padding: 8px 12px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<h3>Time Left: <span id="timer">20:00</span></h3>

<h2 id="question"></h2>
<div id="options"></div>

<button id="nextBtn">Next</button>

<script>
  // â± TIMER
  let timeLeft = 20 * 60;
  let timerInterval;

  window.startTimer = function startTimer() {
    timerInterval = setInterval(() => {
      let minutes = Math.floor(timeLeft / 60);
      let seconds = timeLeft % 60;

      document.getElementById("timer").innerText =
        `${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;

      timeLeft--;

      if (timeLeft < 0) {
        clearInterval(timerInterval);
        finishQuiz();
      }
    }, 1000);
  }
</script>

<script type="module">
  // ðŸ”¥ FIREBASE
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAzDiUTgErSBLG8I_uIZEFo-tPJ4Z-R_Vo",
    authDomain: "ecet-5650a.firebaseapp.com",
    projectId: "ecet-5650a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // âœ… LOCAL DATE (NO UTC BUG)
  const d = new Date();
  const today =
    d.getFullYear() + "-" +
    String(d.getMonth() + 1).padStart(2, "0") + "-" +
    String(d.getDate()).padStart(2, "0");

  let questions = [];
  let index = 0;
  let score = 0;
  let answered = false;

  // ðŸ”’ PREVENT REATTEMPT
 /* if (localStorage.getItem("quizDone_" + today)) {
    document.body.innerHTML = "<h2>You already attempted todayâ€™s quiz</h2>";
    throw new Error("STOP");
  }*/

  async function loadQuiz() {
    const ref = doc(db, "dailyQuiz", today);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      document.body.innerHTML = "<h2>No quiz for today</h2>";
      return;
    }

    // âœ… HANDLE MAP OR ARRAY
    const rawQuestions = snap.data().questions;
    questions = Array.isArray(rawQuestions)
      ? rawQuestions
      : Object.values(rawQuestions);

    if (questions.length === 0) {
      document.body.innerHTML = "<h2>No questions found</h2>";
      return;
    }

    showQuestion();
    startTimer();
  }

  function showQuestion() {
  answered = false;
  const q = questions[index];

  document.getElementById("question").innerText =
    `${index + 1}. ${q.question}`;

  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";

  const optionsArray = Array.isArray(q.options)
    ? q.options
    : Object.values(q.options);

  optionsArray.forEach(opt => {
    const btn = document.createElement("button");
    btn.innerText = opt;

    btn.onclick = () => {
      if (answered) return;
      answered = true;

      if (opt === q.answer) {
        score++;
        btn.style.background = "#4caf50";
      } else {
        btn.style.background = "#f44336";
      }
    };

    optionsDiv.appendChild(btn);
    optionsDiv.appendChild(document.createElement("br"));
  });
}

  document.getElementById("nextBtn").onclick = () => {
    if (!answered) {
      alert("Select an answer first");
      return;
    }

    index++;

    if (index < questions.length) {
      showQuestion();
    } else {
      finishQuiz();
    }
  };

 window.finishQuiz = function finishQuiz() {
    clearInterval(timerInterval);
    localStorage.setItem("quizDone_" + today, "true");

    const percent = Math.round((score / questions.length) * 100);

    document.body.innerHTML = `
      <h2>Quiz Completed âœ…</h2>
      <p>Score: ${score}/${questions.length}</p>
      <p>Percentage: ${percent}%</p>
    `;
  }

  // ðŸš€ START
  loadQuiz();
</script>

</body>
</html>
